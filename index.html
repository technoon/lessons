<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="Tech-noon : Technical Noons" />
    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">
    <title>TechNoon Lessons</title>
  </head>

  <body>
    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <h1 id="project_title">Tech-noon</h1>
          <!-- <h2 id="project_tagline">Technical Lessons</h2> -->
		</header>
		<footer class="inner">
			<p class="copyright">by Rajeshkumar Venkatesan</p>
		</footer>
    </div>

<!-- MAIN CONTENT -->
<div id="main_content_wrap" class="outer">
<section id="main_content" class="inner">
<h3><a name="welcome-to-tech-noons" class="anchor" href="#welcome-to-tech-noons"><span class="octicon octicon-link"></span></a>Welcome to Tech-noons</h3>

<p>Technical Lessons from Technoon. Lets go Technical !</p>
<h3><a name="intro" class="anchor" href="#intro"><span class="octicon octicon-link"></span></a>Lesson -1 : Node.js, Express, EJS & MongoDB</h3>
<p>In this lesson, let see how to do the CRUD operations on MongoDB using Node.js, Express & EJS.  I am assuming you are familiar with Node.js & MongoDB. 
Express is a web application framework for Node.js, which provides the easy way to build web applications with multi pages.  Express comes with 'Jade', a templating engine.
EJS is also a popular templating engine for Node.js.</p>

<h3><a name="L1" class="anchor" href="#L1"><span class="octicon octicon-link"></span></a>How to use Express & EJS</h3>
<p> Install the 'express' & 'ejs' to the node_modules using the below command.</p>

<pre><code>npm install express
npm install ejs
</code></pre>

<p>Let's how to use the express for handling the http requests.  use the require method to import the express library to the node script.  From the below code the express object 'app' 
is passed as an argument to the 'createServer' method, after this all the incoming http get calls will be handled by the express framework.  Save the below script as 'mongocrud.js' and 
run the script as 'node mongocrud.js'.  Access the 'localhost:3000' in the browser, Bingo !  Welcome to Technoons ! </p>

<pre><code>var express = require('express'),
http = require('http');
var app = express();

app.get('/', function(req, res) {
res.send('Welcome to Technoons!');
});

http.createServer(app).listen(3000, function() {
console.log("Server is listening on port 3000"); 
});
</code></pre>

<p>Configure the express by setting the essential parameters. Take a note that 'ejs' is the view engine for this lesson. </p>
<pre><code>app.set('views', __dirname + '/views');
app.set('view engine', 'ejs');
app.use(express.bodyParser());
app.use(express.methodOverride());
app.use(app.router);
app.use(express.static(path.join(__dirname, 'public')));
</code></pre>

<p>Let's see how to display html elements using EJS. In the 'mongocrud.js' add the below code fragment.  So when the request comes the contents in the 'index.ejs'  
will be rendered in the browser.  After this, create a file 'index.ejs' and include the below html fragments.  Note: All .ejs files has to be stored in the "views" folder as per 
the above configuration.</p>

<pre><code>app.get('/', function(req,res) {
res.render('index.ejs');
});
</code></pre>

<image src="https://f.cloud.github.com/assets/6375258/1893658/4d28d370-7aaa-11e3-9fb0-1cb6e0893bd6.PNG"/>

<p>Run the 'mongocrud.js' and access the 'http://localhost:3000/', you will see the below page.  You have learned to use the templating engine.</p>		

<image src="https://f.cloud.github.com/assets/6375258/1893640/78d50cac-7aa8-11e3-8622-4469301353ab.PNG"/>
	
<h3><a name="L1" class="anchor" href="#L1"><span class="octicon octicon-link"></span></a>Accessing MongoDB from Node.js</h3>
<p>Second step in our lesson is 'Accessing MongoDB from Node'.  For accessing MongoDB & the collections the node module 'Mongoose' will be used.  Install the 
Mongoose and import it to the script 'mongocrud.js'.
</p>

<pre><code>npm install mongoose</code></pre>
<pre><code>mongoose = require('mongoose');</code></pre>

<p>Mongoose module provides the easy access to MongoDB.  Opening the connection to the MongoDB is straight forward.  MongoDB comes with a default database 'test'.  
Collections in MongoDB are similar to Tables in RDBMS and Mongo DB uses flexi schema approach.</p>

<pre><code>mongoose.connect('mongodb://localhost/test');</code></pre>

<p>Create a MongoDB schema, collection using the below script. create a reference to the 'product' object which uniquely represents a record in the collection. When this code gets executed, MongoDB creates a 
collection named "Products'.  Note: It adds 's' to the model name given.</p>

<pre><code>var productSchema = new mongoose.Schema({
	prdId: String,
	name: { type: String }, 
	price: Number
})

var Product = mongoose.model('Product', productSchema);
</code></pre>

<!-- Insert -->
<h3><a name="insert" class="anchor" href="#insert"><span class="octicon octicon-link"></span></a>Inserting a record</h3>
<p>First a html 'form' has to be created to capture the product details.  Let's create a simple html form. EJS will be used to define the html form elements. Save this file as 
'addProducts.ejs' and under the 'views' folder.  Note: The submit button invokes a 'post' call. </p>

<image src="https://f.cloud.github.com/assets/6375258/1893763/ed1318f6-7ab3-11e3-8459-8945e6462aa1.PNG"/>

<p>In the mongocrud.js include the below code snippet.  When the url comes with operation as 'add', then the view 'addProduct.ejs' gets invoked. The submit button click invokes the '/new' post.  
Using save() method in Mongoose module, the product details are persisted in MongoDB.</p>

<pre><code>app.get('/add', function(req,res) {
    res.render('addProduct.ejs');
});
app.post('/new', function(req, res){
	new Product({
		prdId	: req.body.ProductId,
		name	: req.body.ProductName,
		price   : req.body.ProductPrice
	}).save(function(err, prd){
		if(err) res.json(err);
		else    res.send("Product Successfully Added !");
	});
});
</code></pre>

<p> Invoke the URL http://localhost:3000/add and submit the form.  Congratulations !!! You have now learnt how to insert a record into MongoDB collection. </p>

<!-- View All -->
<h3><a name="viewall" class="anchor" href="#viewall"><span class="octicon octicon-link"></span></a>Viewing all the records</h3>
<p>JSON is used to send & receive data to MongoDB.  Now, create a 'display.ejs' in the "views" folder with the following html code.</p>

<image src="https://f.cloud.github.com/assets/6375258/1893792/afb2c6c0-7ab6-11e3-9047-0f1cccc2749d.PNG"/>
	
<p>Add the below script to the mongocrud.js.  Function 'renderResult' is a helper function created to re-use the page rendering code.</p>
	
<pre><code>app.get('/viewall', function(req,res) {
    Product.find({}, function(err, prds) {
		console.log("\nProducts !");
		console.log(prds); 
		renderResult(res, prds, "Product List from MongoDB :");
});});
function renderResult(res, prds, msg) {
	res.render('display.ejs', {message:msg, products:prds}, 
		function(err, result) {
			if (!err) {res.end(result);}
			else {res.end('Oops ! An error occurred.');
				console.log(err);}		
});}
</code></pre>

<p>Invoke the URL http://localhost:3000/viewall.  All the records in the "Products" collection in MongoDB will be displayed in this page.</p>
<image src="https://f.cloud.github.com/assets/6375258/1893807/03518766-7ab8-11e3-9020-4b6266a04b7b.PNG"/>
<p>Try yourself : Retrieve a record from MongoDB with a condition and display.  e.g. find a product with id 'prd5555'. </p>
<pre><code>Happy Coding !</code></pre>

</section>
</div>

<!-- FOOTER  -->
<div id="footer_wrap" class="outer">
<footer class="inner">
	<p class="copyright">Technoon maintained by Rajeshkumar Venkatesan</p>
</footer>
</div>

<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-47069620-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
</body>
</html>
